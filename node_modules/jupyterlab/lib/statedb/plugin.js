// Copyright (c) Jupyter Development Team.
// Distributed under the terms of the Modified BSD License.
"use strict";
var index_1 = require("./index");
var _1 = require("./");
/**
 * The default state database for storing application state.
 */
var plugin = {
    activate: activate,
    id: 'jupyter.services.statedb',
    autoStart: true,
    provides: index_1.IStateDB
};
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * Export the plugin as default.
 */
exports.default = plugin;
/**
 * Activate the state database.
 */
function activate(app) {
    var state = new _1.StateDB({ namespace: app.info.namespace });
    var version = app.info.version;
    var command = _1.CommandIDs.clear;
    var key = 'statedb:version';
    var fetch = state.fetch(key);
    var save = function () { return state.save(key, { version: version }); };
    var reset = function () { return state.clear().then(save); };
    var check = function (value) {
        var old = value && value['version'];
        if (!old || old !== version) {
            console.log("Upgraded: " + (old || 'unknown') + " to " + version + "; Resetting DB.");
            return reset();
        }
    };
    app.commands.addCommand(command, {
        label: 'Clear Application Restore State',
        execute: function () { return state.clear(); }
    });
    return fetch.then(check, reset).then(function () { return state; });
}
//# sourceMappingURL=plugin.js.map